# yaml-language-server: $schema=https://raw.githubusercontent.com/omni-oss/omni/refs/heads/json-schemas/project-latest.json
name: omni_remote_cache_service

extends:
  - "@workspace/omni/presets/rust-service.omni.yaml"

tasks:
  build:
    output:
      files:
        - "@workspace/target/release/omni_remote_cache_service"

  dev:
    env:
      vars:
        ADDITIONAL_ARGS: >
          -- serve -b in-memory --routes.enable-openapi

  prod:
    command: >
      ${WORKSPACE_DIR}/target/release/omni_remote_cache_service
      serve
      -b
      local-disk
      --routes.enable-openapi
      --local-disk.root-dir
      ${PROJECT_DIR}/.omni/remote_cache/data

    dependencies:
      - build

    cache:
      enabled: false

  profile:
    dependencies:
      - ^passthrough

meta:
  targets:
    x86_64-unknown-linux-gnu:
      runner: ubuntun-latest
    aarch64-unknown-linux-gnu:
      runner: ubuntu-latest
      # build_flags: --feature vendored-openssl
    x86_64-apple-darwin:
      runner: macos-latest
    aarch64-apple-darwin:
      runner: macos-latest
    x86_64-pc-windows-msvc:
      runner: windows-latest

dependencies:
  - omni_remote_cache_storage
  - omni_tracing_subscriber
  - omni_path_utils
  - maps
  - sets
