name: CI

on:
  push:
    branches: [main]
    paths:
      - "**/*"
      - "!./apps/site/**"
      - "!bun.lock"
    tags:
      - "!v*.*.*"
      - "!*-v*.*.*"
  pull_request:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  restore-key-prefixes: |
    publish_rust_github
    publish_npm
    build_rust
    build_typescript
    test_rust
    test_typescript

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      jobs: ${{ steps.plan.outputs.jobs }}
      jobs_test_typescript: ${{ steps.plan.outputs.jobs_test_typescript }}
      jobs_test_typescript_count: ${{ steps.plan.outputs.jobs_test_typescript_count }}
      jobs_test_rust: ${{ steps.plan.outputs.jobs_test_rust }}
      jobs_test_rust_count: ${{ steps.plan.outputs.jobs_test_rust_count }}
      jobs_build_typescript: ${{ steps.plan.outputs.jobs_build_typescript }}
      jobs_build_typescript_count: ${{ steps.plan.outputs.jobs_build_typescript_count }}
      jobs_build_rust: ${{ steps.plan.outputs.jobs_build_rust }}
      jobs_build_rust_count: ${{ steps.plan.outputs.jobs_build_rust_count }}
      jobs_publish_npm: ${{ steps.plan.outputs.jobs_publish_npm }}
      jobs_publish_npm_count: ${{ steps.plan.outputs.jobs_publish_npm_count }}
      jobs_publish_rust_github: ${{ steps.plan.outputs.jobs_publish_rust_github }}
      jobs_publish_rust_github_count: ${{ steps.plan.outputs.jobs_publish_rust_github_count }}
      jobs_cache_restore_key_prefixes: ${{ steps.plan.outputs.jobs_cache_restore_key_prefixes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Omni
        uses: ./.github/actions/setup-omni
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-key-prefix: plan
          cache-restore-key-prefixes: ${{ env.restore-key-prefixes }}

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          install-all: false
          install-bun: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Dry Run Results
        run: omni run -L -f=failed -d --result=result.json test build publish

      - name: Create Plan
        id: plan
        shell: bash
        run: |
          bun --bun x @omni-oss/create-jobs result.json --output=jobs.json

          # Read the file into a variable
          JOBS=$(cat jobs.json)

          # Function to write multiline output to GITHUB_OUTPUT
          set_output() {
            local name=$1
            local value=$2
            # Use a unique delimiter to handle potential collisions in JSON
            local delimiter="EOF_$(dd if=/dev/urandom bs=15 count=1 status=none | base64)"

            echo "$name<<$delimiter" >> $GITHUB_OUTPUT
            echo "$value" >> $GITHUB_OUTPUT
            echo "$delimiter" >> $GITHUB_OUTPUT
          }

          # 1. Output the full JSON
          set_output "jobs" "$JOBS"

          # 2. Output the specific sections using your JQ logic
          set_output "jobs_test_typescript" "$(echo "$JOBS" | jq -c '.test.typescript')"
          echo "jobs_test_typescript_count=$(echo "$JOBS" | jq '.test.typescript | length')" >> $GITHUB_OUTPUT

          set_output "jobs_test_rust" "$(echo "$JOBS" | jq -c '.test.rust')"
          echo "jobs_test_rust_count=$(echo "$JOBS" | jq '.test.rust | length')" >> $GITHUB_OUTPUT

          set_output "jobs_build_typescript" "$(echo "$JOBS" | jq -c '.build.typescript')"
          echo "jobs_build_typescript_count=$(echo "$JOBS" | jq '.build.typescript | length')" >> $GITHUB_OUTPUT

          set_output "jobs_build_rust" "$(echo "$JOBS" | jq -c '.build.rust')"
          echo "jobs_build_rust_count=$(echo "$JOBS" | jq '.build.rust | length')" >> $GITHUB_OUTPUT

          set_output "jobs_publish_npm" "$(echo "$JOBS" | jq -c '.publish.npm')"
          echo "jobs_publish_npm_count=$(echo "$JOBS" | jq '.publish.npm | length')" >> $GITHUB_OUTPUT

          set_output "jobs_publish_rust_github" "$(echo "$JOBS" | jq -c '.publish.rust_github')"
          echo "jobs_publish_rust_github_count=$(echo "$JOBS" | jq '.publish.rust_github | length')" >> $GITHUB_OUTPUT

          set_output "jobs_cache_restore_key_prefixes" "${{ env.restore-key-prefixes }}"

      - name: Prune Unused Caches
        run: omni cache prune -sy -o="7d" # Remove stale caches older than 7 days

  test-typescript:
    needs:
      - plan
    if: ${{ needs.plan.outputs.jobs_test_typescript_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_test_typescript }}
      cache-key-prefix: test_typescript
      cache-restore-key-prefixes: ${{ needs.plan.outputs.jobs_cache_restore_key_prefixes }}

  test-rust:
    needs:
      - test-typescript
      - plan
    if: ${{ needs.plan.outputs.jobs_test_rust_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_test_rust }}
      multiplatform: true
      cache-key-prefix: test_rust
      cache-restore-key-prefixes: ${{ needs.plan.outputs.jobs_cache_restore_key_prefixes }}

  build-typescript:
    needs:
      - plan
      - test-rust
    if: ${{ needs.plan.outputs.jobs_build_typescript_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_build_typescript }}
      cache-key-prefix: build_typescript
      cache-restore-key-prefixes: ${{ needs.plan.outputs.jobs_cache_restore_key_prefixes }}

  build-rust:
    needs:
      - plan
      - build-typescript
    if: ${{ needs.plan.outputs.jobs_build_rust_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_build_rust }}
      multiplatform: true
      cache-key-prefix: build_rust
      cache-restore-key-prefixes: ${{ needs.plan.outputs.jobs_cache_restore_key_prefixes }}
