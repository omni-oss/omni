name: CI

on:
  push:
    branches: [main]
    paths:
      - "**/*"
      - "!./apps/site/**"
      - "!bun.lock"
    tags:
      - "v*.*.*"
      - "!*-v*.*.*"
  pull_request:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      jobs: ${{ steps.plan.outputs.jobs }}
      jobs_test_typescript: ${{ steps.plan.outputs.jobs_test_typescript }}
      jobs_test_typescript_count: ${{ steps.plan.outputs.jobs_test_typescript_count }}
      jobs_test_rust: ${{ steps.plan.outputs.jobs_test_rust }}
      jobs_test_rust_count: ${{ steps.plan.outputs.jobs_test_rust_count }}
      jobs_build_typescript: ${{ steps.plan.outputs.jobs_build_typescript }}
      jobs_build_typescript_count: ${{ steps.plan.outputs.jobs_build_typescript_count }}
      jobs_build_rust: ${{ steps.plan.outputs.jobs_build_rust }}
      jobs_build_rust_count: ${{ steps.plan.outputs.jobs_build_rust_count }}
      jobs_publish_npm: ${{ steps.plan.outputs.jobs_publish_npm }}
      jobs_publish_npm_count: ${{ steps.plan.outputs.jobs_publish_npm_count }}
      jobs_publish_rust_github: ${{ steps.plan.outputs.jobs_publish_rust_github }}
      jobs_publish_rust_github_count: ${{ steps.plan.outputs.jobs_publish_rust_github_count }}
      jobs_publish_generic: ${{ steps.plan.outputs.jobs_publish_generic }}
      jobs_publish_generic_count: ${{ steps.plan.outputs.jobs_publish_generic_count }}
      jobs_cache_restore_key_prefixes: ${{ steps.plan.outputs.jobs_cache_restore_key_prefixes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Omni
        uses: ./.github/actions/setup-omni
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-key-prefix: plan
          cache-restore-key-prefixes: |
            publish_rust_github
            publish_generic
            publish_npm
            build_rust
            build_typescript
            test_rust
            test_typescript
            plan

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          install-all: false
          install-bun: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Dry Run Results
        run: omni -i run -L -f=failed -d --result=result.json test build publish

      - name: Create Plan
        id: plan
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const execSync = require('child_process').execSync;

            // 1. Run the bun command
            execSync('bun --bun x @omni-oss/create-jobs result.json --output=jobs.json');

            // 2. Read and parse the generated JSON
            const jobsRaw = fs.readFileSync('jobs.json', 'utf8');
            const jobs = JSON.parse(jobsRaw);

            const updateArtifactData = (data) => {
                // do nothing for now
            }

            // Helper to set both the stringified JSON and the length count
            const setJobOutput = (name, data) => {
                data.forEach(updateArtifactData);
                core.setOutput(name, JSON.stringify(data));
                core.setOutput(`${name}_count`, data ? data.length : 0);
            };

            // 3. Set the full jobs output
            core.setOutput('jobs', jobsRaw);

            // 4. Set specific sections
            setJobOutput('jobs_test_typescript', jobs.test?.typescript || []);
            setJobOutput('jobs_test_rust', jobs.test?.rust || []);

            setJobOutput('jobs_build_typescript', jobs.build?.typescript || []);
            setJobOutput('jobs_build_rust', jobs.build?.rust || []);

            setJobOutput('jobs_publish_npm', jobs.publish?.npm || []);
            setJobOutput('jobs_publish_rust_github', jobs.publish?.rust_github || []);
            setJobOutput('jobs_publish_generic', jobs.publish?.generic || []);

            // 5. Handle the environment variable prefix
            core.setOutput('jobs_cache_restore_key_prefixes', process.env['restore-key-prefixes']);

      - name: Prune Unused Caches
        run: omni -i cache prune -sy -o="7d" # Remove stale caches older than 7 days

  test-rust:
    needs:
      - plan
    if: ${{ needs.plan.outputs.jobs_test_rust_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_test_rust }}
      cache-key-prefix: test_rust
      cache-restore-key-prefixes: |
        publish_rust_github
        build_rust
        test_rust

  test-typescript:
    needs:
      - test-rust
      - plan
    if: ${{ needs.plan.outputs.jobs_test_typescript_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_test_typescript }}
      cache-key-prefix: test_typescript
      cache-restore-key-prefixes: |
        publish_npm
        build_typescript
        test_typescript

  build-rust:
    needs:
      - test-typescript
      - plan
    if: ${{ needs.plan.outputs.jobs_build_rust_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_build_rust }}
      cache-key-prefix: build_rust
      cache-restore-key-prefixes: |
        publish_rust_github
        build_rust
      save-outputs: true
      artifacts-name: build-rust

  build-typescript:
    needs:
      - test-typescript
      - plan
    if: ${{ needs.plan.outputs.jobs_build_typescript_count > 0 }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_build_typescript }}
      cache-key-prefix: build_typescript
      cache-restore-key-prefixes: |
        build_typescript
        test_typescript
      save-outputs: true
      artifacts-name: build-typescript

  publish-generic:
    needs:
      - build-rust
      - build-typescript
      - plan
    if: ${{ needs.plan.outputs.jobs_publish_generic_count > 0 && startsWith(github.ref, 'refs/tags/') }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_publish_generic }}
      cache-key-prefix: publish_generic
      cache-restore-key-prefixes: |
        publish_generic
        publish_rust_github
        publish_npm
        build_rust
        build_typescript
        test_rust
        test_typescript

  publish-npm:
    needs:
      - build-rust
      - build-typescript
      - plan
    if: ${{ needs.plan.outputs.jobs_publish_generic_count > 0 && startsWith(github.ref, 'refs/tags/') }}
    uses: ./.github/workflows/run-omni-jobs.yaml
    with:
      jobs: ${{ needs.plan.outputs.jobs_publish_npm }}
      cache-key-prefix: publish_npm
      cache-restore-key-prefixes: |
        publish_npm
        build_rust
        build_typescript
