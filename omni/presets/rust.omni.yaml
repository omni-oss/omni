# yaml-language-server: $schema=https://raw.githubusercontent.com/omni-oss/omni/refs/heads/json-schemas/project-latest.json
name: rust

cache:
  key:
    files:
      - "Cargo.toml"
      - "./src/**/*.rs"

extends:
  - "./base.omni.yaml"

tasks:
  test:
    command: cargo test -p ${PROJECT_NAME}
    dependencies:
      - ^test
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        files:
          append: ["./tests/**/*.rs"]

  bench:
    command: cargo bench -p ${PROJECT_NAME}
    dependencies:
      - test
      - ^bench
    cache:
      key:
        files:
          append: ["./benches/**/*.rs"]

  profile:
    command: >
      cargo flamegraph
        --profile=${profile:-bench-with-debug}
        --bench ${bench:-${PROJECT_NAME}_benchmarks}
        -p ${project:-${PROJECT_NAME}}
        --
        --bench --profile-time=${profile_time:-5}

meta:
  language: rust
