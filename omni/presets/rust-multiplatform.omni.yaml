# yaml-language-server: $schema=https://raw.githubusercontent.com/omni-oss/omni/refs/heads/json-schemas/project-latest.json
name: rust-multiplatform

extends:
  - ./rust.omni.yaml

cache:
  key:
    env:
      append:
        - RUST_TARGET

tasks:
  test:aarch64-unknown-linux-gnu:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('aarch64-unknown-linux-gnu') }}"
    command: cargo test --target aarch64-unknown-linux-gnu -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:aarch64-unknown-linux-gnu
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:x86_64-unknown-linux-gnu:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('x86_64-unknown-linux-gnu') }}"
    command: cargo test --target x86_64-unknown-linux-gnu -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:x86_64-unknown-linux-gnu
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:x86_64-apple-darwin:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('x86_64-apple-darwin') }}"
    command: cargo test --target x86_64-apple-darwin -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:x86_64-apple-darwin
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:aarch64-apple-darwin:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('aarch64-apple-darwin') }}"
    command: cargo test --target aarch64-apple-darwin -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:aarch64-apple-darwin
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:x86_64-pc-windows-msvc:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('x86_64-pc-windows-msvc') }}"
    command: cargo test --target x86_64-pc-windows-msvc -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:x86_64-pc-windows-msvc
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:aarch64-pc-windows-msvc:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('aarch64-pc-windows-msvc') }}"
    command: cargo test --target aarch64-pc-windows-msvc -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:aarch64-pc-windows-msvc
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:current:
    enabled: "{{ not env.RUST_TARGET or env.RUST_TARGET == '' }}"
    command: cargo test -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^test:current
    env:
      vars:
        # RUST_LOG_SPAN_EVENTS: new,close
        RUST_LOG: trace
    cache:
      key:
        env:
          append: [RUST_TEST_ADDITIONAL_ARGS]
        files:
          append: ["./tests/**/*.rs"]

  test:
    command: "echo 'Test completed'"
    dependencies:
      - ^test
      - test:current
      - test:aarch64-unknown-linux-gnu
      - test:x86_64-unknown-linux-gnu
      - test:x86_64-apple-darwin
      - test:aarch64-apple-darwin
      - test:x86_64-pc-windows-msvc
      - test:aarch64-pc-windows-msvc

  build:aarch64-unknown-linux-gnu:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('aarch64-unknown-linux-gnu') }}"
    command: cargo build --release --target aarch64-unknown-linux-gnu -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:aarch64-unknown-linux-gnu
    output:
      files:
        - "@workspace/target/aarch64-unknown-linux-gnu/release/{{ env.PROJECT_NAME }}"
        - "@workspace/target/release/{{ env.PROJECT_NAME }}"
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:x86_64-unknown-linux-gnu:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('x86_64-unknown-linux-gnu') }}"
    command: cargo build --release --target x86_64-unknown-linux-gnu -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:x86_64-unknown-linux-gnu
    output:
      files:
        - "@workspace/target/x86_64-unknown-linux-gnu/release/{{ env.PROJECT_NAME }}"
        - "@workspace/target/release/{{ env.PROJECT_NAME }}"
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:x86_64-apple-darwin:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('x86_64-apple-darwin') }}"
    command: cargo build --release --target x86_64-apple-darwin -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:x86_64-apple-darwin
    output:
      files:
        - "@workspace/target/x86_64-apple-darwin/release/{{ env.PROJECT_NAME }}"
        - "@workspace/target/release/{{ env.PROJECT_NAME }}"
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:aarch64-apple-darwin:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('aarch64-apple-darwin') }}"
    command: cargo build --release --target aarch64-apple-darwin -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:aarch64-apple-darwin
    output:
      files:
        - "@workspace/target/aarch64-apple-darwin/release/{{ env.PROJECT_NAME }}"
        - "@workspace/target/release/{{ env.PROJECT_NAME }}"
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:x86_64-pc-windows-msvc:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('x86_64-pc-windows-msvc') }}"
    command: cargo build --release --target x86_64-pc-windows-msvc -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:x86_64-pc-windows-msvc
    output:
      files:
        - "@workspace/target/x86_64-pc-windows-msvc/release/{{ env.PROJECT_NAME }}.exe"
        - "@workspace/target/release/{{ env.PROJECT_NAME }}.exe"
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:aarch64-pc-windows-msvc:
    enabled: "{{ env.RUST_TARGET and env.RUST_TARGET is containing('aarch64-pc-windows-msvc') }}"
    command: cargo build --release --target aarch64-pc-windows-msvc -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:aarch64-pc-windows-msvc
    output:
      files:
        - "@workspace/target/aarch64-pc-windows-msvc/release/{{ env.PROJECT_NAME }}.exe"
        - "@workspace/target/release/{{ env.PROJECT_NAME }}.exe"
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:current:
    enabled: "{{ not env.RUST_TARGET or env.RUST_TARGET == '' }}"
    command: cargo build --release -p ${PROJECT_NAME} ${RUST_TEST_ADDITIONAL_ARGS:-}
    dependencies:
      - ^build:current
    cache:
      key:
        env:
          append: [RUST_BUILD_ADDITIONAL_ARGS]

  build:
    dependencies:
      - test
      - build:current
      - build:aarch64-unknown-linux-gnu
      - build:x86_64-unknown-linux-gnu
      - build:x86_64-apple-darwin
      - build:aarch64-apple-darwin
      - build:x86_64-pc-windows-msvc
      - build:aarch64-pc-windows-msvc

meta:
  targets:
    x86_64-unknown-linux-gnu:
      runner: ubuntu-latest
    aarch64-unknown-linux-gnu:
      runner: ubuntu-latest
    x86_64-apple-darwin:
      runner: macos-latest
    aarch64-apple-darwin:
      runner: macos-latest
    x86_64-pc-windows-msvc:
      runner: windows-latest
